# ESP32-S3 8-Channel Closed-Loop PID Servo Controller

本仓库包含一个基于 ESP32-S3 的高性能、8通道、闭环 PID 舵机控制器固件。该固件专为需要高精度和高响应速度位置控制的应用（如 VTOL、机器人或高阶 DIY项目）而设计。

它利用 ESP32-S3 的双核架构，将实时 PID 控制（运行在 Core 1）与通信/辅助任务（运行在 Core 0）完全分离。

## ✨ 核心特性

* **8 通道闭环控制**: 通过 ADC 读取 8 个通道的位置反馈（例如电位器），并驱动 8 个 PWM 信号以实现精确的位置伺服。
* **双核架构**:
    * **Core 1 (RT)**: 专用于高优先级的 PID 循环任务。循环由硬件定时器触发（在 `config.h` 中配置为 1kHz）。
    * **Core 0**: 处理 USB 串行通信、遥测数据输出和 SBUS 帧的生成。
* **高频 PID 环路**: 使用 `QuickPID` 库，硬件定时器以 1kHz (1000µs) 的频率（可在 `config.h` 中配置）精确触发 PID 计算。
* **SBUS 输出**: 将 8 个舵机的最终位置（1000-2000us）打包成标准的 SBUS 信号帧，并通过 `SBUS_PIN` (GPIO 14) 发送。
* **USB 串行接口**:
    * **实时遥测**: 以 10Hz 的频率通过 USB 串行输出所有 8 个通道的当前 ADC 值、目标 ADC 值和最终 PWM 输出。
    * **命令控制**: 接收二进制命令包，用于实时设置单个舵机的目标位置。
* **PID 自动调参**: 集成了 `pid-autotune` 库。可以通过串行命令触发对单个舵机的自动 PID 调参过程。

## ⚙️ 硬件与引脚配置

固件的引脚配置在 `config.h` 文件中定义。

| 功能 | 引脚 (GPIO) | 描述 |
| :--- | :--- | :--- |
| **ADC 反馈 (Input)** | 1, 2, 3, 4, 5, 6, 7, 8 | 8个舵机的位置反馈 (电位器) |
| **PWM 输出 (Output)**| 42, 41, 40, 39, 38, 37, 36, 35 | 8个舵机的 PWM 驱动信号 |
| **SBUS (Output)** | 14 | 100kbps SBUS (反向UART) 输出 |
| **NeoPixel LED** | 48 | 板载状态指示灯 |

## 🚀 如何使用

1.  **硬件连接**:
    * 将 8 个舵机的反馈电位器信号线连接到 `ADC_PINS`。
    * 将 8 个舵机的信号线连接到 `PWM_PINS`。
    * （可选）将 `SBUS_PIN` 连接到您的飞控或 SBUS 解码器。
2.  **校准 (重要!)**:
    * 打开 `config.h` 文件。
    * **必须** 手动修改 `g_servo_limits` 结构体数组。
    * 物理上将每个舵机移动到其最小和最大机械极限位置，记录下 ADC 读数，并填入 `min_adc` 和 `max_adc`。
    * 填入一个安全的 `center_adc` 值，用于自动调参的目标点。
3.  **编译与烧录**:
    * 使用 Arduino IDE 或 PlatformIO，安装所需的库 (`QuickPID`, `pid-autotune`, `Adafruit_NeoPixel`)。
    * 选择正确的 ESP32-S3 开发板。
    * 编译并上传固件。
4.  **控制与调参**:
    * 打开串行监视器（波特率 115200）。
    * 您将立即看到遥测数据流。
    * 按照下文 **通信协议 (API)** 中的说明发送命令包来设置目标或开始自动调参。

## 📚 关键文件

* `Dq_Vtol_Esp32s3_SbusTest2.ino`: 主程序文件，包含任务创建、PID 循环、通信处理和自动调参逻辑。
* `config.h`: **所有用户配置的唯一位置**。包括引脚定义、PID 增益、环路速率、SBUS 设置和舵机 ADC 校准值。

---

## 💻 通信协议 (API)

ESP32-S3 舵机控制器通过 USB 串行接口（波特率 **115200**）进行通信。

通信分为两种：
1.  **遥测 (输出)**: ESP32 以 10Hz 的频率自动向主机发送的可读 ASCII 字符串。
2.  **命令 (输入)**: 主机向 ESP32 发送的紧凑型二进制数据包，用于控制舵机或触发功能。

### 1. 遥测 (输出)

固件以 10Hz 的频率自动发送一行 ASCII 文本，显示所有8个通道的当前状态。

**格式**:
遥测数据以 `[` 开始，以 `]` 结束，每个舵机的信息独立成组。